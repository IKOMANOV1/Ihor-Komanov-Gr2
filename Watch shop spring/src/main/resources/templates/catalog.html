<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout :: head}"></head>

<body>

    <nav th:replace="~{layout :: navbar}"></nav>

    <main class="container">
        <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Catalog</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                    <a th:href="@{/catalog(sort='price_asc', q=${q})}" class="btn btn-sm btn-outline-secondary">Price
                        &uarr;</a>
                    <a th:href="@{/catalog(sort='price_desc', q=${q})}" class="btn btn-sm btn-outline-secondary">Price
                        &darr;</a>
                    <a th:href="@{/catalog(sort='brand', q=${q})}" class="btn btn-sm btn-outline-secondary">Brand</a>
                </div>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
            <div class="col" th:each="watch : ${watches}">
                <div class="card shadow-sm h-100">
                    <img th:src="${watch.imageUrl != null ? watch.imageUrl : 'https://via.placeholder.com/200'}"
                        class="card-img-top" alt="...">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title" th:text="${watch.nazwa}">Name</h5>
                        <h6 class="card-subtitle mb-2 text-muted" th:text="${watch.brand}">Brand</h6>
                        <p class="card-text flex-grow-1" th:text="${watch.description}">Desc</p>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="fs-5" th:text="${watch.price} + ' PLN'">Price</span>

                            <div th:if="${watch.inStock > 0}" class="d-flex gap-2">
                                <a th:href="@{/watch/{id}(id=${watch.id})}" class="btn btn-outline-secondary">View</a>
                                <div class="input-group" style="width: 140px;">
                                    <input type="number" class="form-control" value="1" min="1"
                                        th:max="${watch.inStock}" th:id="'qty-' + ${watch.id}">
                                    <button class="btn btn-primary" type="button"
                                        th:onclick="'addToCart(' + ${watch.id} + ')'">Buy</button>
                                </div>
                            </div>
                            <span th:unless="${watch.inStock > 0}" class="text-danger">Out of Stock</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <nav aria-label="Page navigation" th:if="${watchesPage.totalPages > 1}" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${!watchesPage.hasPrevious()} ? 'disabled'">
                    <a class="page-link"
                        th:href="@{/catalog(page=${watchesPage.number - 1}, size=${watchesPage.size}, q=${q}, sort=${sort})}">Previous</a>
                </li>
                <li class="page-item disabled">
                    <span class="page-link"
                        th:text="${'Page ' + (watchesPage.number + 1) + ' of ' + watchesPage.totalPages}"></span>
                </li>
                <li class="page-item" th:classappend="${!watchesPage.hasNext()} ? 'disabled'">
                    <a class="page-link"
                        th:href="@{/catalog(page=${watchesPage.number + 1}, size=${watchesPage.size}, q=${q}, sort=${sort})}">Next</a>
                </li>
            </ul>
        </nav>
    </main>

    <div th:replace="~{layout :: footer}"></div>

    <script>
        // AJAX Add to Cart
        function addToCart(watchId) {
            const qtyInput = document.getElementById('qty-' + watchId);
            const quantity = qtyInput ? qtyInput.value : 1;

            const csrfToken = document.querySelector('input[name="_csrf"]')?.value; // If CSRF enabled

            fetch('/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'X-CSRF-TOKEN': csrfToken 
                },
                body: JSON.stringify({
                    watchId: watchId,
                    quantity: quantity
                })
            })
                .then(response => {
                    if (response.ok) {
                        alert("Added to cart!");
                        // Optionally update cart count in navbar
                    } else if (response.status === 401) {
                        window.location.href = '/login';
                    } else {
                        return response.text().then(text => { throw new Error(text) });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Error adding to cart: " + error.message);
                });
        }
    </script>

</body>

</html>